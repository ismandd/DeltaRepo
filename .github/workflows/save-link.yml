name: Save Final Link

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  save-link:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch final .ipa URL
        run: |
          HTML=$(curl -s https://gloopup.net/Delta/ios/)
          FINAL_URL=$(echo "$HTML" | grep -oP '(?<=href=")[^"]+\.ipa' | head -n 1 || true)

          if [ -z "$FINAL_URL" ]; then
            echo "No IPA URL found, real error."
            exit 1
          fi

          FILENAME=$(basename "$FINAL_URL")
          TAG="${FILENAME%.*}"

          # Extract real version (Delta-2.702.633.ipa → 2.702.633)
          VERSION=$(echo "$FILENAME" | sed -E 's/^Delta-([0-9.]+)\.ipa$/\1/')

          echo "FINAL_URL=$FINAL_URL" >> $GITHUB_ENV
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Detect change
        run: |
          OLD_URL=""
          [ -f link.txt ] && OLD_URL=$(cat link.txt)

          if [ "$OLD_URL" = "$FINAL_URL" ]; then
            echo "CHANGED=false" >> $GITHUB_ENV
            echo "Already latest — skipping release creation."
          else
            echo "CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Save link.txt
        if: env.CHANGED == 'true'
        run: |
          echo "$FINAL_URL" > link.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add link.txt
          git commit -m "Update link.txt" || true
          git push || true

      - name: Download IPA (original name)
        if: env.CHANGED == 'true'
        run: |
          for i in {1..10}; do
            echo "Download attempt $i..."
            curl -fL -o "$FILENAME" "$FINAL_URL" && break
            sleep 60
          done
          [ -f "$FILENAME" ] || exit 1

      - name: Download IPA as Delta.ipa
        if: env.CHANGED == 'true'
        run: |
          for i in {1..10}; do
            echo "Download attempt $i..."
            curl -fL -o Delta.ipa "$FINAL_URL" && break
            sleep 60
          done
          [ -f "Delta.ipa" ] || exit 1

      - name: Update repo.json (AltStore fix)
        if: env.CHANGED == 'true'
        run: |
          SIZE=$(stat -c%s Delta.ipa)
          DATE=$(date +%Y-%m-%d)

          jq \
            --arg version "$VERSION" \
            --arg date "$DATE" \
            --argjson size "$SIZE" \
            '
            .apps[0].versions[0].version = $version |
            .apps[0].versions[0].date = $date |
            .apps[0].versions[0].size = $size
            ' repo.json > repo.tmp.json

          mv repo.tmp.json repo.json

      - name: Commit repo.json
        if: env.CHANGED == 'true'
        run: |
          git add repo.json
          git commit -m "Update repo.json for Delta $VERSION" || true
          git push || true

      - name: Create tag (if missing)
        if: env.CHANGED == 'true'
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "Tag already exists — skipping tag creation."
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Create release (if missing)
        if: env.CHANGED == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "$TAG" &>/dev/null; then
            echo "Release already exists — skipping creation."
          else
            gh release create "$TAG" "$FILENAME" Delta.ipa --title "$FILENAME"
          fi

      - name: Cleanup old releases (after success)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG="${TAG}"

          gh release list --limit 100 | awk '{print $1}' | while read OLD_TAG; do
            [ "$OLD_TAG" = "$CURRENT_TAG" ] && continue
            echo "Deleting old release $OLD_TAG"
            gh release delete "$OLD_TAG" -y || true
            git push origin --delete "$OLD_TAG" || true
          done
