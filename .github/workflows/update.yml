name: Update Delta AltStore Repo

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours
  workflow_dispatch:         # Manual trigger support

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Generate repo.json
        run: |
          python3 - <<EOF
          import requests, json
          from datetime import datetime

          res = requests.get("https://delta.webfiles.pro/get_files.php")
          data = res.json()
          ipa = data["latest_ipa"][0]

          version = ipa["name"].replace("Delta-", "").replace(".ipa", "")
          date = datetime.fromtimestamp(ipa["timestamp"]).isoformat()
          download_url = f"https://delta.webfiles.pro/file/{ipa['name']}"

          repo_data = {
              "name": "Delta Source",
              "subtitle": "Official Delta builds, updated automatically.",
              "description": "Get the latest Delta emulator straight from the web.",
              "iconURL": "https://delta.webfiles.pro/assets/delta_icon.png",
              "headerURL": "https://delta.webfiles.pro/assets/delta_icon.png",
              "website": "https://delta.webfiles.pro",
              "tintColor": "#A145A6",
              "featuredApps": ["com.rileytestut.Delta"],
              "apps": [{
                  "name": "Delta",
                  "bundleIdentifier": "com.rileytestut.Delta",
                  "developerName": "Riley Testut",
                  "subtitle": "The best iOS emulator.",
                  "localizedDescription": "Play Nintendo games on iOS with Delta emulator.",
                  "iconURL": "https://delta.webfiles.pro/assets/delta_icon.png",
                  "tintColor": "#A145A6",
                  "screenshots": [],
                  "versions": [{
                      "version": version,
                      "date": date,
                      "size": ipa["size"],
                      "downloadURL": download_url,
                      "localizedDescription": f"Delta version {version}.",
                      "minOSVersion": "12.0"
                  }]
              }],
              "news": []
          }

          with open("repo.json", "w") as f:
              json.dump(repo_data, f, indent=4)
          EOF

      - name: Commit and Push if Changed
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add repo.json
          git commit -m "Update repo.json with latest Delta IPA" || echo "No changes to commit"
          git push
